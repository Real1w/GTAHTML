<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MicroDrako GTA: Urban Empire</title>

  <!-- PHASER 3 (for 2.5D GTA-like top-down/isometric gameplay) -->
  <script src="https://cdn.jsdelivr.net/npm/phaser@3.80.1/dist/phaser.min.js"></script>

  <!-- SOCKET.IO for Multiplayer & Persistence -->
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>

  <!-- MATTER.JS for Physics (collisions, damage, etc.) -->
  <script src="https://cdn.jsdelivr.net/npm/matter-js@0.19.0/build/matter.min.js"></script>

  <!-- UI: Bootstrap + Custom -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { background:#000; overflow:hidden; font-family:'Courier New', monospace; }
    #game-container { position:relative; width:100vw; height:100vh; }
    canvas { display:block; image-rendering:pixelated; }
    .ui-overlay { position:absolute; top:0; left:0; width:100%; height:100%; pointer-events:none; }
    .hud { position:absolute; bottom:10px; left:10px; color:#fff; background:rgba(0,0,0,0.6); padding:10px; border-radius:8px; font-size:14px; }
    .minimap { position:absolute; top:10px; right:10px; width:180px; height:180px; border:3px solid #fff; border-radius:50%; overflow:hidden; background:#111; }
    .minimap canvas { width:100%; height:100%; }
    .loading-screen { position:fixed; top:0; left:0; width:100vw; height:100vh; background:#000 url('https://i.imgur.com/5z5Y7kT.jpg') center/cover; display:flex; flex-direction:column; justify-content:center; align-items:center; color:#fff; z-index:9999; transition:opacity 0.5s; }
    .loading-bar { width:50%; height:20px; background:#333; border-radius:10px; overflow:hidden; margin-top:20px; }
    .loading-fill { height:100%; width:0%; background:linear-gradient(90deg, #ff0044, #ffaa00); transition:width 0.1s; }
    .menu { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); background:rgba(0,0,0,0.9); padding:30px; border-radius:15px; color:#fff; text-align:center; width:400px; display:none; }
    .btn-gta { background:#c00; color:#fff; border:none; padding:12px 24px; margin:10px; border-radius:6px; font-weight:bold; cursor:pointer; }
    .btn-gta:hover { background:#f00; }
    .blood-splash { position:absolute; pointer-events:none; width:60px; height:60px; background:url('https://i.imgur.com/8pK3mXv.png') center/contain no-repeat; opacity:0; transform:translate(-50%,-50%); animation:blood 0.6s forwards; }
    @keyframes blood { 0%{opacity:1;transform:scale(0.5) translate(-50%,-50%);} 100%{opacity:0;transform:scale(1.5) translate(-50%,-50%);} }
  </style>
</head>
<body>

  <!-- LOADING SCREEN (FAST, GTA-STYLE) -->
  <div id="loading-screen" class="loading-screen">
    <h1 style="font-size:3rem; text-shadow:0 0 10px #f00;">MICRODRAKO GTA</h1>
    <p>Loading Urban Empire...</p>
    <div class="loading-bar"><div id="loading-fill" class="loading-fill"></div></div>
  </div>

  <!-- MAIN MENU -->
  <div id="main-menu" class="menu">
    <h2>SELECT YOUR PATH</h2>
    <button class="btn-gta" onclick="startGame('street')">Street Hustler</button>
    <button class="btn-gta" onclick="startGame('business')">Business Tycoon</button>
    <button class="btn-gta" onclick="startGame('gangster')">Gangster Legend</button>
    <p style="margin-top:20px; font-size:12px;">Starting Cash: <strong>$1,000,000</strong></p>
  </div>

  <!-- GAME CONTAINER -->
  <div id="game-container">
    <!-- HUD -->
    <div class="ui-overlay">
      <div class="hud">
        <div>Cash: <span id="cash">$1,000,000</span></div>
        <div>Health: <span id="health">100</span>%</div>
        <div>Wanted: <span id="wanted">â˜†â˜†â˜†â˜†â˜†</span></div>
        <div>Weapon: <span id="weapon">7.62 ARP</span></div>
      </div>
      <div class="minimap" id="minimap-container">
        <canvas id="minimap-canvas"></canvas>
      </div>
    </div>
  </div>

  <!-- GUN SHOP MODAL -->
  <div class="modal fade" id="gunshop-modal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content bg-dark text-white">
        <div class="modal-header"><h5>Ammu-Nation</h5></div>
        <div class="modal-body">
          <div class="list-group">
            <a href="#" class="list-group-item bg-secondary text-white" onclick="buyWeapon('Pistol', 500)">Pistol - $500</a>
            <a href="#" class="list-group-item bg-secondary text-white" onclick="buyWeapon('7.62 ARP', 5000)">7.62 ARP - $5,000</a>
            <a href="#" class="list-group-item bg-secondary text-white" onclick="buyWeapon('RPG', 20000)">RPG - $20,000</a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- CAR SHOP MODAL -->
  <div class="modal fade" id="carshop-modal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content bg-dark text-white">
        <div class="modal-header"><h5>Premium Deluxe Motorsport</h5></div>
        <div class="modal-body">
          <div class="list-group">
            <a href="#" class="list-group-item bg-secondary text-white" onclick="buyCar('Mercedes S63', 150000)">Mercedes S63 - $150,000</a>
            <a href="#" class="list-group-item bg-secondary text-white" onclick="buyCar('BMW M8', 180000)">BMW M8 - $180,000</a>
            <a href="#" class="list-group-item bg-secondary text-white" onclick="buyCar('Jetpack', 500000)">Jetpack (Fly) - $500,000</a>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
// ======================
// MICRODRAKO GTA ENGINE
// ======================

let game, player, socket, cash = 1000000, health = 100, wanted = 0, currentWeapon = '7.62 ARP';
let minimapCtx, missions = [], npcs = [], vehicles = [], bloodPool = [];

// PRELOAD ASSETS (SPRITES, SOUNDS, TEXTURES)
const ASSETS = {
  player: 'https://i.imgur.com/3WqXKpM.png', // Character sprite
  mercedes: 'https://i.imgur.com/9kL2mPq.png',
  bmw: 'https://i.imgur.com/7vN3xZs.png',
  jetpack: 'https://i.imgur.com/5kLmN9p.png',
  npc: 'https://i.imgur.com/8xPqR2t.png',
  blood: 'https://i.imgur.com/8pK3mXv.png',
  city: 'https://i.imgur.com/2fX9kLm.jpg',
  gunshop: 'https://i.imgur.com/4rT6vYk.png',
  carshop: 'https://i.imgur.com/6pL8mQw.png',
};

// FAST LOADING SIMULATION
let loadProgress = 0;
const loadingFill = document.getElementById('loading-fill');
const loadingScreen = document.getElementById('loading-screen');
const loadInterval = setInterval(() => {
  loadProgress += Math.random() * 12;
  loadingFill.style.width = Math.min(loadProgress, 100) + '%';
  if (loadProgress >= 100) {
    clearInterval(loadInterval);
    setTimeout(() => {
      loadingScreen.style.opacity = '0';
      setTimeout(() => {
        loadingScreen.style.display = 'none';
        document.getElementById('main-menu').style.display = 'block';
      }, 500);
    }, 300);
  }
}, 80);

// START GAME
function startGame(mode) {
  document.getElementById('main-menu').style.display = 'none';
  initGame(mode);
}

// INIT PHASER + MATTER + SOCKET
function initGame(mode) {
  const config = {
    type: Phaser.AUTO,
    parent: 'game-container',
    width: window.innerWidth,
    height: window.innerHeight,
    physics: { default: 'matter', matter: { gravity: { y: 0 }, debug: false } },
    scene: { preload, create, update },
    backgroundColor: '#000'
  };
  game = new Phaser.Game(config);

  // WebSocket Multiplayer
  socket = io('wss://microdrako-gta-server.onrender.com'); // Use your server
  socket.on('playerUpdate', data => { /* sync others */ });
  socket.on('npcUpdate', data => { /* sync NPCs */ });
}

// PHASER SCENE
function preload() {
  this.load.image('city', ASSETS.city);
  this.load.image('player', ASSETS.player);
  this.load.image('npc', ASSETS.npc);
  this.load.image('mercedes', ASSETS.mercedes);
  this.load.image('bmw', ASSETS.bmw);
  this.load.image('jetpack', ASSETS.jetpack);
  this.load.image('gunshop', ASSETS.gunshop);
  this.load.image('carshop', ASSETS.carshop);
}

function create() {
  const worldWidth = 4000, worldHeight = 4000;
  this.matter.world.setBounds(0, 0, worldWidth, worldHeight);

  // CITY BACKGROUND
  const city = this.add.image(worldWidth/2, worldHeight/2, 'city').setDepth(-1);
  city.setScale(2);

  // PLAYER
  player = this.matter.add.sprite(2000, 2000, 'player').setScale(0.8).setFixedRotation();
  player.setBody({ type: 'rectangle', width: 40, height: 60 });
  this.cameras.main.startFollow(player, true, 0.1, 0.1);

  // MINIMAP
  const minimapCanvas = document.getElementById('minimap-canvas');
  minimapCanvas.width = 180; minimapCanvas.height = 180;
  minimapCtx = minimapCanvas.getContext('2d');

  // MISSIONS
  missions = [
    { name: "Rob Ammu-Nation", x: 1500, y: 1200, icon: 'ðŸ”«', reward: 10000 },
    { name: "Steal BMW", x: 3000, y: 2500, icon: 'ðŸš—', reward: 15000 }
  ];

  // NPCS & TRAFFIC
  for (let i = 0; i < 50; i++) {
    const npc = this.matter.add.sprite(
      Phaser.Math.Between(500, 3500),
      Phaser.Math.Between(500, 3500),
      'npc'
    ).setScale(0.6);
    npc.setVelocity(Phaser.Math.Between(-2, 2), Phaser.Math.Between(-2, 2));
    npcs.push(npc);
  }

  // SHOPS
  this.matter.add.image(1500, 1200, 'gunshop').setStatic(true).setScale(1.5);
  this.matter.add.image(3000, 2500, 'carshop').setStatic(true).setScale(1.5);

  // INPUT
  this.keys = this.input.keyboard.addKeys('W,A,S,D,SPACE,E');

  // GUN SHOP COLLISION
  this.matterCollision.addOnCollideStart({
    objectA: player,
    callback: event => {
      const other = event.bodyB.gameObject;
      if (other && other.texture.key === 'gunshop') {
        $('#gunshop-modal').modal('show');
      }
      if (other && other.texture.key === 'carshop') {
        $('#carshop-modal').modal('show');
      }
    }
  });
}

function update() {
  const speed = 5;
  const body = player.body;

  // MOVEMENT
  if (this.keys.W.isDown) body.velocity.y = -speed;
  else if (this.keys.S.isDown) body.velocity.y = speed;
  else body.velocity.y *= 0.9;

  if (this.keys.A.isDown) body.velocity.x = -speed;
  else if (this.keys.D.isDown) body.velocity.x = speed;
  else body.velocity.x *= 0.9;

  // SHOOT (7.62 ARP)
  if (this.keys.SPACE.isDown && !this.shooting) {
    this.shooting = true;
    shootBullet(this);
    setTimeout(() => this.shooting = false, 200);
  }

  // UPDATE MINIMAP
  updateMinimap();

  // NPC AI
  npcs.forEach(npc => {
    if (Math.random() < 0.01) {
      npc.setVelocity(Phaser.Math.Between(-3, 3), Phaser.Math.Between(-3, 3));
    }
  });

  // SYNC TO SERVER
  socket.emit('playerUpdate', { x: player.x, y: player.y, health, cash });
}

// SHOOTING + BLOOD
function shootBullet(scene) {
  const bullet = scene.matter.add.rectangle(player.x + 50, player.y, 8, 4, { isSensor: true });
  scene.matter.body.setVelocity(bullet, 20, 0);

  scene.time.delayedCall(1000, () => scene.matter.world.remove(bullet));

  scene.matterCollision.addOnCollideActive({
    objectA: bullet,
    callback: hit => {
      const target = hit.bodyB.gameObject;
      if (target && target !== player) {
        createBlood(player.x + 50, player.y);
        if (target.texture.key === 'npc') {
          target.destroy();
          cash += 500;
          updateHUD();
        }
        scene.matter.world.remove(bullet);
        wanted = Math.min(wanted + 1, 5);
        updateWanted();
      }
    }
  });
}

function createBlood(x, y) {
  const splash = document.createElement('div');
  splash.className = 'blood-splash';
  splash.style.left = x + 'px';
  splash.style.top = y + 'px';
  document.body.appendChild(splash);
  setTimeout(() => splash.remove(), 600);
}

// MINIMAP
function updateMinimap() {
  minimapCtx.clearRect(0, 0, 180, 180);
  minimapCtx.fillStyle = '#222';
  minimapCtx.fillRect(0, 0, 180, 180);

  // Player
  minimapCtx.fillStyle = '#0f0';
  minimapCtx.fillRect(90 - 3, 90 - 3, 6, 6);

  // Missions
  missions.forEach(m => {
    const mx = (m.x / 4000) * 180;
    const my = (m.y / 4000) * 180;
    minimapCtx.fillStyle = '#ff0';
    minimapCtx.font = '12px Arial';
    minimapCtx.fillText(m.icon, mx - 6, my + 4);
  });
}

// HUD
function updateHUD() {
  document.getElementById('cash').innerText = '$' + cash.toLocaleString();
  document.getElementById('health').innerText = health;
  document.getElementById('wanted').innerText = 'â˜…'.repeat(wanted) + 'â˜†'.repeat(5 - wanted);
}
function updateWanted() { updateHUD(); }

// WEAPONS & CARS
function buyWeapon(name, price) {
  if (cash >= price) {
    cash -= price;
    currentWeapon = name;
    document.getElementById('weapon').innerText = name;
    updateHUD();
    $('#gunshop-modal').modal('hide');
  }
}
function buyCar(name, price) {
  if (cash >= price) {
    cash -= price;
    updateHUD();
    $('#carshop-modal').modal('hide');
    alert(`You bought a ${name}! Use E to enter.`);
    // Spawn vehicle near player
  }
}

// RESIZE
window.addEventListener('resize', () => {
  game.scale.resize(window.innerWidth, window.innerHeight);
});

// BOOTSTRAP
const bootstrapScript = document.createElement('script');
bootstrapScript.src = 'https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js';
document.body.appendChild(bootstrapScript);

</script>
</body>
</html>
